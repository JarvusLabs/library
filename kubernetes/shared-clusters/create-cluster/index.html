
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="canonical" href="http://jarvuslabs.github.io/library/kubernetes/shared-clusters/create-cluster/">
      
      <link rel="shortcut icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-6.2.5">
    
    
      
        <title>Create a cluster - Jarvus Labs Library</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.15aa0b43.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.75751829.min.css">
        
          
          
          <meta name="theme-color" content="#ffa724">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.13.0/css/all.css">
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="orange" data-md-color-accent="deep-purple">
      
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#create-a-cluster" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="http://jarvuslabs.github.io/library/" title="Jarvus Labs Library" class="md-header-nav__button md-logo" aria-label="Jarvus Labs Library">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      <div class="md-header-nav__ellipsis">
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            Jarvus Labs Library
          </span>
        </div>
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            
              Create a cluster
            
          </span>
        </div>
      </div>
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/JarvusLabs/library/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../../.." class="md-tabs__link">
      Welcome
    </a>
  </li>

      
        
  
  
    
  


  
  
  
    

  
  
  
    <li class="md-tabs__item">
      <a href="../../recipes/restic-snapshots/" class="md-tabs__link md-tabs__link--active">
        Kubernetes
      </a>
    </li>
  

  

      
    </ul>
  </div>
</nav>
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="http://jarvuslabs.github.io/library/" title="Jarvus Labs Library" class="md-nav__button md-logo" aria-label="Jarvus Labs Library">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    Jarvus Labs Library
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/JarvusLabs/library/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        Welcome
      </a>
    </li>
  

    
      
      
      


  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2" checked>
      
      <label class="md-nav__link" for="nav-2">
        Kubernetes
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Kubernetes" data-md-level="1">
        <label class="md-nav__title" for="nav-2">
          <span class="md-nav__icon md-icon"></span>
          Kubernetes
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
          
            
  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2-1" type="checkbox" id="nav-2-1" >
      
      <label class="md-nav__link" for="nav-2-1">
        Recipes
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Recipes" data-md-level="2">
        <label class="md-nav__title" for="nav-2-1">
          <span class="md-nav__icon md-icon"></span>
          Recipes
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../recipes/restic-snapshots/" class="md-nav__link">
        Restic Snapshots
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
            
  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2-2" type="checkbox" id="nav-2-2" checked>
      
      <label class="md-nav__link" for="nav-2-2">
        Shared clusters
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Shared clusters" data-md-level="2">
        <label class="md-nav__title" for="nav-2-2">
          <span class="md-nav__icon md-icon"></span>
          Shared clusters
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Create a cluster
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Create a cluster
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#set-up-cluster-repository" class="md-nav__link">
    Set up cluster repository
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-github-token-for-deploy-workflows" class="md-nav__link">
    Create GitHub token for deploy workflows
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-service-account" class="md-nav__link">
    Create service account
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-github-token-for-cluster-image-pulls" class="md-nav__link">
    Create GitHub token for cluster image pulls
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../deploy-project/" class="md-nav__link">
        Deploying a project
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#set-up-cluster-repository" class="md-nav__link">
    Set up cluster repository
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-github-token-for-deploy-workflows" class="md-nav__link">
    Create GitHub token for deploy workflows
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-service-account" class="md-nav__link">
    Create service account
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#create-github-token-for-cluster-image-pulls" class="md-nav__link">
    Create GitHub token for cluster image pulls
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/JarvusLabs/library/edit/master/docs/kubernetes/shared-clusters/create-cluster.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="create-a-cluster">Create a cluster<a class="headerlink" href="#create-a-cluster" title="Permanent link"> ¶</a></h1>
<p><em>Coming soon</em></p>
<p>For now, see:</p>
<ul>
<li><a href="https://github.com/JarvusInnovations/cluster-template">cluster-template</a>: Jarvus&rsquo; public template for lightweight, self-sufficient, multi-project Kubernetes clusters.</li>
<li><a href="https://github.com/JarvusInnovations/jarvus-sandbox-cluster">jarvus-sandbox-cluster</a>: If you have access, this repository demonstrates the setup documented in this section.</li>
</ul>
<h2 id="set-up-cluster-repository">Set up cluster repository<a class="headerlink" href="#set-up-cluster-repository" title="Permanent link"> ¶</a></h2>
<ol>
<li>
<p>Create a new repo (e.g. <code>cluster-live</code>) and configure it with hologit, for example:
<div class="highlight"><pre><span></span><code>git init cluster-live &amp;&amp; cd cluster-live
touch README.md &amp;&amp; git add . &amp;&amp; git commit -m &quot;wip: initial commit&quot;
git holo init &amp;&amp; git commit -m &quot;feat: configure holo workspace&quot;
</code></pre></div></p>
</li>
<li>
<p>Add <code>cluster-template</code> as holosource in <code>.holo/sources</code></p>
</li>
</ol>
<p><code>.holo/sources/cluster-template.toml</code>
<div class="highlight"><pre><span></span><code>[holosource]
url = &quot;https://github.com/JarvusInnovations/cluster-template&quot;
ref = &quot;refs/tags/v0.4.0&quot;
</code></pre></div>
3. Add holobranch for <code>cluster-template</code> using the <code>k8s-blueprint</code> holomapping in <code>.holo/branches</code></p>
<p><code>.holo/branches/k8s-manifests/_cluster-template.toml</code>
<div class="highlight"><pre><span></span><code>[holomapping]
holosource = &quot;=&gt;k8s-blueprint&quot;
files = &quot;**&quot;
before = &quot;*&quot;
</code></pre></div></p>
<ol>
<li>Add your own k8s manifests/settings to the repo e.g. Cluster Issuers for <strong>cert-manager</strong> certificates</li>
</ol>
<p><code>cert-manager.issuers.yaml</code></p>
<div class="highlight"><pre><span></span><code>apiVersion: cert-manager.io/v1alpha2
kind: ClusterIssuer
metadata:
  name: letsencrypt-staging
spec:
  acme:
    email: email@example.com
    server: https://acme-staging-v02.api.letsencrypt.org/directory
    privateKeySecretRef:
      name: letsencrypt-staging
    solvers:
    - http01:
        ingress:
          class: nginx
---

apiVersion: cert-manager.io/v1alpha2
kind: ClusterIssuer
metadata:
  name: letsencrypt-prod
spec:
  acme:
    email: email@example.com
    server: https://acme-v02.api.letsencrypt.org/directory
    privateKeySecretRef:
      name: letsencrypt-prod
    solvers:
    - http01:
        ingress:
          class: nginx
</code></pre></div>
<ol>
<li>
<p>Project manifests into <code>k8s/manifests</code> branch
<div class="highlight"><pre><span></span><code>git holo project --working k8s-manifests --commit-to=k8s/manifests
</code></pre></div></p>
</li>
<li>
<p>Checkout the branch, and diff/apply the changes in the repo to the cluster.
<div class="highlight"><pre><span></span><code>git checkout k8s/manifests

kubectl diff -Rf ./

kubectl apply -Rf ./
</code></pre></div></p>
</li>
</ol>
<h2 id="create-github-token-for-deploy-workflows">Create GitHub token for deploy workflows<a class="headerlink" href="#create-github-token-for-deploy-workflows" title="Permanent link"> ¶</a></h2>
<p>The GitHub Actions deployment workflow requires a GitHub bot user to write to the cluster repository with. This is necessary so that a branch pushed by the GitHub Actions workflow can trigger subsequent workflows. The authentication tokens that are automatically provided to all GitHub Actions workflow runs are able to push to the host repository, but their pushes are prevented from triggering any workflows.</p>
<ol>
<li>Create or reuse GitHub bot user with write access to the cluster repository </li>
<li>Grant the GitHub bot user the write access to the cluster repository, and ensure that its invitation is accepted</li>
<li><a href="https://docs.github.com/en/free-pro-team@latest/github/authenticating-to-github/creating-a-personal-access-token">Create a Personal Access Token</a> under the GitHub bot user with <code>workflow</code> scope</li>
<li>Save the generated Personal Access Token to a secret called <code>BOT_GITHUB_TOKEN</code> under the cluster repository</li>
</ol>
<h2 id="create-service-account">Create service account<a class="headerlink" href="#create-service-account" title="Permanent link"> ¶</a></h2>
<p>The GitHub Actions Workflows driving deployments will need a service account with read/write access to all namespaces. Add this manifest to the cluster&rsquo;s GitHub repository under e.g. <code>deployers/cluster.yaml</code> where it will become part of the automated deployment, but you will need to apply it to the cluster manually ahead of the first automated deployment:</p>
<div class="tabbed-set" data-tabs="1:2"><input checked="checked" id="__tabbed_1_1" name="__tabbed_1" type="radio" /><label for="__tabbed_1_1">deployers/cluster.yaml</label><div class="tabbed-content">
<div class="highlight"><pre><span></span><code><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ServiceAccount</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">cluster-deployer</span>
<span class="nt">namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kube-system</span>

<span class="nn">---</span>

<span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io/v1</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ClusterRole</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">cluster-deployer</span>
<span class="nt">rules</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">apiGroups</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&quot;*&quot;</span><span class="p p-Indicator">]</span>
<span class="nt">resources</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&quot;*&quot;</span><span class="p p-Indicator">]</span>
<span class="nt">verbs</span><span class="p">:</span> <span class="p p-Indicator">[</span><span class="s">&quot;*&quot;</span><span class="p p-Indicator">]</span>

<span class="nn">---</span>

<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">RoleBinding</span>
<span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io/v1beta1</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">cluster-deployer</span>
<span class="nt">namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kube-system</span>
<span class="nt">roleRef</span><span class="p">:</span>
<span class="nt">apiGroup</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">rbac.authorization.k8s.io</span>
<span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ClusterRole</span>
<span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">cluster-deployer</span>
<span class="nt">subjects</span><span class="p">:</span>
<span class="p p-Indicator">-</span> <span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">ServiceAccount</span>
<span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">cluster-deployer</span>
<span class="nt">namespace</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">kube-system</span>
</code></pre></div>
</div>
<input id="__tabbed_1_2" name="__tabbed_1" type="radio" /><label for="__tabbed_1_2">mkkubeconfig</label><div class="tabbed-content">
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>
<span class="c1"># adapted from: https://gist.github.com/ericchiang/d2a838ddad3f44436ae001a342e1001e</span>

<span class="nv">TEMPDIR</span><span class="o">=</span><span class="k">$(</span> mktemp -d <span class="k">)</span>

<span class="nb">trap</span> <span class="s2">&quot;{ rm -rf </span><span class="nv">$TEMPDIR</span><span class="s2"> ; exit 255; }&quot;</span> EXIT

<span class="nv">SA_SECRET</span><span class="o">=</span><span class="k">$(</span> kubectl get sa -n <span class="nv">$1</span> <span class="nv">$2</span> -o <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.secrets[0].name}&#39;</span> <span class="k">)</span>

<span class="c1"># Pull the bearer token and cluster CA from the service account secret.</span>
<span class="nv">BEARER_TOKEN</span><span class="o">=</span><span class="k">$(</span> kubectl get secrets -n <span class="nv">$1</span> <span class="nv">$SA_SECRET</span> -o <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.data.token}&#39;</span> <span class="p">|</span> base64 -d <span class="k">)</span>
kubectl get secrets -n <span class="nv">$1</span> <span class="nv">$SA_SECRET</span> -o <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.data.ca\.crt}&#39;</span> <span class="p">|</span> base64 -d &gt; <span class="nv">$TEMPDIR</span>/ca.crt

<span class="nv">CLUSTER_URL</span><span class="o">=</span><span class="k">$(</span> kubectl config view -o <span class="nv">jsonpath</span><span class="o">=</span><span class="s1">&#39;{.clusters[0].cluster.server}&#39;</span> <span class="k">)</span>

<span class="nv">KUBECONFIG</span><span class="o">=</span><span class="nv">$TEMPDIR</span>/kubeconfig.yaml

<span class="m">1</span>&gt;<span class="p">&amp;</span><span class="m">2</span> kubectl config --kubeconfig<span class="o">=</span><span class="nv">$KUBECONFIG</span> <span class="se">\</span>
    set-cluster <span class="se">\</span>
    <span class="nv">$CLUSTER_URL</span> <span class="se">\</span>
    --server<span class="o">=</span><span class="nv">$CLUSTER_URL</span> <span class="se">\</span>
    --certificate-authority<span class="o">=</span><span class="nv">$TEMPDIR</span>/ca.crt <span class="se">\</span>
    --embed-certs<span class="o">=</span><span class="nb">true</span>

<span class="m">1</span>&gt;<span class="p">&amp;</span><span class="m">2</span> kubectl config --kubeconfig<span class="o">=</span><span class="nv">$KUBECONFIG</span> <span class="se">\</span>
    set-credentials <span class="nv">$2</span> --token<span class="o">=</span><span class="nv">$BEARER_TOKEN</span>

<span class="m">1</span>&gt;<span class="p">&amp;</span><span class="m">2</span> kubectl config --kubeconfig<span class="o">=</span><span class="nv">$KUBECONFIG</span> <span class="se">\</span>
    set-context registry <span class="se">\</span>
    --cluster<span class="o">=</span><span class="nv">$CLUSTER_URL</span> <span class="se">\</span>
    --user<span class="o">=</span><span class="nv">$2</span>

<span class="m">1</span>&gt;<span class="p">&amp;</span><span class="m">2</span> kubectl config --kubeconfig<span class="o">=</span><span class="nv">$KUBECONFIG</span> <span class="se">\</span>
    use-context registry

cat <span class="nv">$KUBECONFIG</span>
</code></pre></div>
</div>
</div>
<ol>
<li>
<p>Apply manifests to create service account:</p>
<div class="highlight"><pre><span></span><code>kubectl apply -f deployers/cluster.yaml
</code></pre></div>
</li>
<li>
<p>Use provided script to generate a base64-encoded KUBECONFIG for GitHub:</p>
<div class="highlight"><pre><span></span><code>./mkkubeconfig kube-system cluster-deployer <span class="p">|</span> base64
</code></pre></div>
</li>
<li>
<p>Save the base64 blob output above to a secret called <code>KUBECONFIG_BASE64</code> under the cluster repository</p>
</li>
</ol>
<h2 id="create-github-token-for-cluster-image-pulls">Create GitHub token for cluster image pulls<a class="headerlink" href="#create-github-token-for-cluster-image-pulls" title="Permanent link"> ¶</a></h2>
<p>If deployments will utilize Docker container images uploaded to GitHub&rsquo;s Packages registry, the deployment workflow can handle injecting these into any desired namespace.</p>
<ol>
<li>Create or reuse GitHub bot user with write access to the cluster repository</li>
<li>Grant the GitHub bot user write access to the cluster repository, and ensure that its invitation is accepted</li>
<li><a href="https://docs.github.com/en/free-pro-team@latest/github/authenticating-to-github/creating-a-personal-access-token">Create a Personal Access Token</a> under the GitHub bot user with the <code>read:packages</code> scope</li>
<li>
<p>Generate a base64-encoded <code>.docker/config.json</code> file:</p>
<div class="highlight"><pre><span></span><code><span class="nb">echo</span> -n <span class="s1">&#39;Username: &#39;</span> <span class="o">&amp;&amp;</span> <span class="nb">read</span> github_username
<span class="nb">echo</span> -n <span class="s1">&#39;Password: &#39;</span> <span class="o">&amp;&amp;</span> <span class="nb">read</span> -s github_token
<span class="nb">echo</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">&quot;{ \&quot;auths\&quot;: { \&quot;docker.pkg.github.com\&quot;: { \&quot;auth\&quot;: \&quot;</span><span class="k">$(</span><span class="nb">echo</span> -n <span class="s2">&quot;</span><span class="si">${</span><span class="nv">github_username</span><span class="si">}</span><span class="s2">:</span><span class="si">${</span><span class="nv">github_token</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">|</span> base64<span class="k">)</span><span class="s2">\&quot; } } }&quot;</span> <span class="p">|</span> base64
</code></pre></div>
</li>
<li>
<p>Save the generated base64 blob to a secret called <code>DOCKER_CONFIG_BASE64</code> under the cluster repository</p>
</li>
</ol>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../../recipes/restic-snapshots/" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Restic Snapshots
              </div>
            </div>
          </a>
        
        
          <a href="../deploy-project/" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Deploying a project
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../assets/javascripts/vendor.93c04032.min.js"></script>
      <script src="../../../assets/javascripts/bundle.83e5331e.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script>
      
      <script>
        app = initialize({
          base: "../../..",
          features: ['navigation.tabs'],
          search: Object.assign({
            worker: "../../../assets/javascripts/worker/search.8c7e0a7e.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
        <script src="https://unpkg.com/mermaid@8.5.0/dist/mermaid.min.js"></script>
      
    
  </body>
</html>